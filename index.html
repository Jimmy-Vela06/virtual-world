<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Road-Markings</title>
		<link href="styles.css" rel="stylesheet" />
	</head>
	<body>
		<h1>Markings</h1>
		<canvas id="myCanvas"></canvas>

		<!-- graph 1 buttons -->
		<div id="controls">
			<!-- <button onclick="addRandomPoint()">Add Point</button>
      <button onclick="addRandomSegment()">Add Segment</button>
      <button onclick="removeRandomPoint()">Remove Point</button>
      <button onclick="removeRandomSegment()">Remove Segment</button>
      <button onclick="clearBtn()">Clear</button> -->

			<button onclick="save()">üíæ</button>
			<button onclick="dispose()">üóëÔ∏è</button>
			&nbsp;
			<button id="graphBtn" onclick="setMode('graph')">üèóÔ∏èüë∑üèº‚Äç‚ôÇÔ∏è</button>
			<button id="stopBtn" onclick="setMode('stop')">üõë</button>
			<button id="yieldBtn" onclick="setMode('yield')">‚ö†Ô∏è</button>
			<button id="crossingBtn" onclick="setMode('crossing')">üö∂</button>
			<button id="parkingBtn" onclick="setMode('parking')">üÖøÔ∏è</button>
			<button id="lightBtn" onclick="setMode('light')">üö¶</button>
			<button id="startBtn" onclick="setMode('start')">üöô</button>
			<button id="targetBtn" onclick="setMode('target')">üéØ</button>
		</div>

		<script src="js/world.js"></script>
		<script src="js/viewport.js"></script>
		<script src="js/math/graph.js"></script>
		<script src="js/markings/marking.js"></script>
		<script src="js/markings/stop.js"></script>
		<script src="js/markings/start.js"></script>
		<script src="js/markings/crossing.js"></script>
		<script src="js/markings/parking.js"></script>
		<script src="js/markings/light.js"></script>
		<script src="js/markings/target.js"></script>
		<script src="js/markings/yield.js"></script>
		<script src="js/editors/markingEditor.js"></script>
		<script src="js/editors/graphEditor.js"></script>
		<script src="js/editors/crossingEditor.js"></script>
		<script src="js/editors/stopEditor.js"></script>
		<script src="js/editors/startEditor.js"></script>
		<script src="js/editors/parkingEditor.js"></script>
		<script src="js/editors/lightEditor.js"></script>
		<script src="js/editors/targetEditor.js"></script>
		<script src="js/editors/yieldEditor.js"></script>
		<script src="js/items/tree.js"></script>
		<script src="js/items/building.js"></script>
		<script src="js/math/utils.js"></script>
		<script src="js/primitives/point.js"></script>
		<script src="js/primitives/segment.js"></script>
		<script src="js/primitives/polygon.js"></script>
		<script src="js/primitives/envelope.js"></script>
		<script>
			function addRandomPoint() {
				const success = graph.newPoint(
					new Point(
						Math.random() * myCanvas.width,
						Math.random() * myCanvas.height
					)
				);
				ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
				graph.draw(ctx);
				console.log(success);
			}

			function addRandomSegment() {
				const randomPointOne = Math.floor(Math.random() * graph.points.length);
				const randomPointTwo = Math.floor(Math.random() * graph.points.length);
				const success = graph.newSegment(
					new Segment(
						graph.points[randomPointOne],
						graph.points[randomPointTwo]
					)
				);

				ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
				graph.draw(ctx);
				console.log(success);
			}

			function removeRandomSegment() {
				if (graph.segments.length === 0) {
					console.log('No Segments Found ‚ùå');
					return;
				}
				const randomSegIndex = Math.floor(
					Math.random() * graph.segments.length
				);

				graph.removeSegment(graph.segments[randomSegIndex]);

				ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
				graph.draw(ctx);
			}

			function removeRandomPoint() {
				if (graph.points.length === 0) {
					console.log('No Points to Remove ‚ùå');
				}
				const randomPointsIndex = Math.floor(
					Math.random() * graph.points.length
				);
				graph.removePoint(graph.points[randomPointsIndex]);
				console.log(graph.points[randomPointsIndex]);

				ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
				graph.draw(ctx);
			}

			function clearBtn() {
				graph.clearGraph();
				ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
				graph.draw(ctx);
			}

			let myCanvas = document.getElementById('myCanvas');
			let viewportWidth = window.innerWidth * 0.9; // 90% of viewport width
			// let viewportHeight = window.innerHeight * 0.8; // 90% of viewport height

			myCanvas.width = viewportWidth;
			myCanvas.height = 600;

			const ctx = myCanvas.getContext('2d');

			// const p1 = new Point(100, 100);
			// const p2 = new Point(500, 200);
			// const p3 = new Point(500, 500);
			// const p4 = new Point(100, 300);

			// const s1 = new Segment(p1, p2);
			// const s3 = new Segment(p1, p4);
			// const s2 = new Segment(p4, p2);
			// const s4 = new Segment(p2, p3);

			const graphString = localStorage.getItem('graph');
			const graphInfo = graphString ? JSON.parse(graphString) : null;

			const graph = graphInfo ? Graph.load(graphInfo) : new Graph();

			const world = new World(graph);

			// graph.draw(ctx);

			const viewport = new ViewPort(myCanvas);

			// const graphEditor = new GraphEditor(viewport, graph);

			// const stopEditor = new StopEditor(viewport, world);
			const tools = {
				graph: {button: graphBtn, editor: new GraphEditor(viewport, graph)},
				stop: {button: stopBtn, editor: new StopEditor(viewport, world)},
				crossing: {
					button: crossingBtn,
					editor: new CrossingEditor(viewport, world),
				},
				start: {button: startBtn, editor: new StartEditor(viewport, world)},
				parking: {
					button: parkingBtn,
					editor: new ParkingEditor(viewport, world),
				},
				light: {button: lightBtn, editor: new LightEditor(viewport, world)},
				target: {button: targetBtn, editor: new TargetEditor(viewport, world)},
				yield: {button: yieldBtn, editor: new YieldEditor(viewport, world)},
			};

			let oldGraphHash = graph.hash();

			setMode('graph');

			animate();

			function animate() {
				viewport.reset();
				if (graph.hash() != oldGraphHash) {
					world.generate();
					oldGraphHash = graph.hash();
				}
				const viewPoint = scale(viewport.getOffset(), -1);
				world.draw(ctx, viewPoint);
				ctx.globalAlpha = 0.3;
				for (const tool of Object.values(tools)) {
					tool.editor.display();
				}
				requestAnimationFrame(animate);
			}

			function dispose() {
				tools['graph'].editor.dispose();
				world.markings.length = 0;
			}

			function save() {
				localStorage.setItem('graph', JSON.stringify(graph));
			}

			function setMode(mode) {
				dissableEditors();
				tools[mode].button.style.backgroundColor = 'white';
				tools[mode].button.style.filter = '';
				tools[mode].editor.enable();
			}

			function dissableEditors() {
				for (const tool of Object.values(tools)) {
					tool.button.style.backgroundColor = 'gray';
					tool.button.style.filter = 'grayscale(100%)';
					tool.editor.disable();
				}
			}
		</script>
	</body>
</html>
